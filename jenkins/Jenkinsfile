pipeline {
    agent any

    environment {
        APP_NAME = 'transport-app'
        APP_VERSION = 'v1'
        KUBE_NAMESPACE = 'transport'
    }

    stages {

        stage('ğŸ” Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
            }
        }

        stage('ğŸ Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installing Python dependencies...'
                dir('transport-optimization-devops/app') {
                    bat '''
                        python -m pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('ğŸ§ª Run Tests') {
            steps {
                echo 'ğŸ§ª Running tests (if any)...'
                dir('transport-optimization-devops/app') {
                    bat 'python -m pytest tests/ || exit /b 0'
                }
            }
        }

        stage('ğŸ³ Build Docker Image (Local)') {
            steps {
                echo 'ğŸ—ï¸ Building Docker image locally...'
                dir('transport-optimization-devops') {
                    bat 'docker build -t %APP_NAME%:%APP_VERSION% -f docker/Dockerfile .'
                }
            }
        }

        stage('â˜¸ï¸ Kubernetes Connectivity Check') {
            steps {
                echo 'ğŸ” Checking Kubernetes access...'
                bat '''
                    kubectl version --client
                    kubectl get nodes
                '''
            }
        }

        stage('ğŸ“ Create Namespace') {
            steps {
                echo 'ğŸ“ Ensuring Kubernetes namespace exists...'
                bat 'kubectl create namespace %KUBE_NAMESPACE% --dry-run=client -o yaml | kubectl apply -f -'
            }
        }

        stage('ğŸš€ Deploy to Kubernetes') {
            steps {
                echo 'ğŸš€ Deploying application to Kubernetes...'
                bat '''
                    kubectl delete deployment %APP_NAME% -n %KUBE_NAMESPACE% --ignore-not-found=true
                    kubectl apply -f kubernetes/deployment.yaml -n %KUBE_NAMESPACE%
                    kubectl apply -f kubernetes/service.yaml -n %KUBE_NAMESPACE%
                '''
            }
        }

        stage('âœ… Verify Deployment') {
            steps {
                echo 'âœ… Verifying deployment status...'
                bat '''
                    timeout /t 15
                    kubectl rollout status deployment/%APP_NAME% -n %KUBE_NAMESPACE% --timeout=3m
                    kubectl get pods -n %KUBE_NAMESPACE% -o wide
                    kubectl get svc -n %KUBE_NAMESPACE%
                '''
            }
        }

        stage('ğŸŒ Application URL') {
            steps {
                echo 'ğŸŒ Getting application access information...'
                bat '''
                    echo.
                    echo ========================================
                    echo APPLICATION DEPLOYED SUCCESSFULLY!
                    echo ========================================
                    echo.
                    echo Access your application:
                    echo 1. Port Forward: kubectl port-forward -n %KUBE_NAMESPACE% svc/%APP_NAME%-service 5000:80
                    echo 2. Minikube: minikube service %APP_NAME%-service -n %KUBE_NAMESPACE%
                    echo.
                    kubectl get svc -n %KUBE_NAMESPACE% %APP_NAME%-service
                '''
            }
        }
    }

    post {
        success {
            echo 'âœ… âœ… âœ… PIPELINE COMPLETED SUCCESSFULLY! âœ… âœ… âœ…'
            echo 'ğŸ‰ Application deployed to Kubernetes cluster!'
            echo 'ğŸ“± Check the Application URL stage for access instructions'
        }
        failure {
            echo 'âŒ âŒ âŒ PIPELINE FAILED! âŒ âŒ âŒ'
            echo 'ğŸ“‹ Check the console output above for error details'
            echo 'ğŸ’¡ Common fixes:'
            echo '   - Ensure kubectl can access the cluster'
            echo '   - Check Docker daemon is running'
            echo '   - Verify namespace and resources exist'
        }
        always {
            echo 'ğŸ§¹ Pipeline execution finished at ' + new Date().format('yyyy-MM-dd HH:mm:ss')
        }
    }
}
