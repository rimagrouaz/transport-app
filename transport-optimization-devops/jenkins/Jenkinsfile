pipeline {
    agent any

    environment {
        APP_NAME = 'transport-app'
        APP_VERSION = "v${env.BUILD_NUMBER}"
        KUBE_NAMESPACE = 'transport'
    }

    stages {
        stage('üîç Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                checkout scm
            }
        }

        stage('üêç Python: Install & Test') {
            agent {
                docker {
                    image 'python:3.9-slim'
                    args '-u root'
                }
            }
            steps {
                echo 'üì¶ Installation des d√©pendances et Tests...'
                dir('transport-optimization-devops/app') {
                    sh '''
                        python -m pip install --upgrade pip
                        pip install -r requirements.txt pytest
                        python -m pytest tests/ || echo "‚ö†Ô∏è Aucun test trouv√© ou √©chec des tests."
                    '''
                }
            }
        }

        stage('üê≥ Build Docker Image') {
            steps {
                echo "üèóÔ∏è Construction de l'image Docker : ${APP_NAME}:${APP_VERSION}"
                dir('transport-optimization-devops') {
                    sh "docker build -t ${APP_NAME}:${APP_VERSION} -f docker/Dockerfile ."
                }
            }
        }

        stage('‚ò∏Ô∏è Kubernetes: Deploy') {
            agent {
                docker {
                    image 'bitnami/kubectl:latest'
                    args '-u root --entrypoint='
                }
            }
            steps {
                echo 'üöÄ D√©ploiement vers le cluster Kubernetes...'
                withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECFG')]) {
                    dir('transport-optimization-devops') {
                        sh '''
                            cp ${KUBECFG} ./kubeconfig_tmp
                            export KUBECONFIG=./kubeconfig_tmp
                            
                            echo "Network fix: Pointing 127.0.0.1 to host.docker.internal"
                            sed -i 's/127.0.0.1/host.docker.internal/g' ./kubeconfig_tmp
                            
                            # On d√©finit un alias pour inclure le skip-tls automatiquement
                            alias k='kubectl --insecure-skip-tls-verify=true'

                            echo "üîç V√©rification de la connexion au cluster..."
                            k cluster-info
                            
                            echo "üìÅ Cr√©ation du namespace ${KUBE_NAMESPACE}..."
                            k create namespace ${KUBE_NAMESPACE} --dry-run=client -o yaml | k apply -f -
                            
                            echo "üöÄ Application des manifestes YAML..."
                            k apply -f kubernetes/deployment.yaml -n ${KUBE_NAMESPACE}
                            k apply -f kubernetes/service.yaml -n ${KUBE_NAMESPACE}
                            
                            echo "üîÑ Mise √† jour de l'image vers ${APP_NAME}:${APP_VERSION}..."
                            k set image deployment/${APP_NAME} ${APP_NAME}=${APP_NAME}:${APP_VERSION} -n ${KUBE_NAMESPACE}
                            
                            echo "‚úÖ V√©rification du statut..."
                            k rollout status deployment/${APP_NAME} -n ${KUBE_NAMESPACE} --timeout=2m
                        '''
                    }
                }
            }
        }
    }

    post {
        success { echo '‚úÖ ‚úÖ ‚úÖ PIPELINE TERMIN√â AVEC SUCC√àS ! ‚úÖ ‚úÖ ‚úÖ' }
        failure { echo '‚ùå ‚ùå ‚ùå LE PIPELINE A √âCHOU√â ! ‚ùå ‚ùå ‚ùå' }
        always {
            echo 'üßπ Nettoyage...'
            sh 'docker image prune -f || true'
        }
    }
}
